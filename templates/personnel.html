{% extends "base.html" %}
{% block title %}Personnel - ERP Construction{% endblock %}
{% block content %}
<div class="row mb-4">
    <div class="col-md-6">
        <h1><i class="fas fa-users"></i> Personnel</h1>
    </div>
    <div class="col-md-6 text-end">
        <button class="btn btn-primary" onclick="alert('Fonction d\'ajout à venir')">
            <i class="fas fa-plus"></i> Nouveau Salarié
        </button>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div class="row mb-3">
            <div class="col-md-4">
                <input type="text" id="searchInput" class="form-control" placeholder="Rechercher...">
            </div>
            <div class="col-md-3">
                <select id="filterDivision" class="form-select">
                    <option value="">Toutes les divisions</option>
                </select>
            </div>
            <div class="col-md-3">
                <select id="filterActif" class="form-select">
                    <option value="true">Actifs</option>
                    <option value="">Tous</option>
                    <option value="false">Inactifs</option>
                </select>
            </div>
            <div class="col-md-2">
                <button class="btn btn-secondary w-100" onclick="loadPersonnel()">
                    <i class="fas fa-sync"></i> Actualiser
                </button>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Matricule</th>
                        <th>Nom & Prénom</th>
                        <th>Secteur</th>
                        <th>Division</th>
                        <th>Fonction</th>
                        <th>Salaire (LEI)</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="personnelTable">
                    <tr>
                        <td colspan="7" class="text-center">
                            <div class="spinner-border" role="status"></div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    loadPersonnel();
    $('#searchInput, #filterDivision, #filterActif').on('input change', filterPersonnel);
});

let personnelData = [];
let divisions = new Set();

function loadPersonnel() {
    $.ajax({
        url: '/api/personnel',
        method: 'GET',
        success: function(data) {
            personnelData = data;
            
            // Extraire les divisions uniques
            divisions = new Set();
            data.forEach(p => {
                if (p.division) divisions.add(p.division);
            });
            
            // Remplir le filtre de division
            $('#filterDivision').html('<option value="">Toutes les divisions</option>');
            Array.from(divisions).sort().forEach(div => {
                $('#filterDivision').append(`<option value="${div}">${div}</option>`);
            });
            
            displayPersonnel(data);
        },
        error: function(error) {
            console.error('Erreur:', error);
            $('#personnelTable').html('<tr><td colspan="7" class="text-center text-danger">Erreur lors du chargement</td></tr>');
        }
    });
}

function displayPersonnel(personnel) {
    const tbody = $('#personnelTable');
    tbody.empty();
    
    if (personnel.length === 0) {
        tbody.html('<tr><td colspan="7" class="text-center">Aucun salarié trouvé</td></tr>');
        return;
    }
    
    personnel.forEach(p => {
        const badgeActif = p.actif ? '<span class="badge bg-success">Actif</span>' : '<span class="badge bg-secondary">Inactif</span>';
        
        tbody.append(`
            <tr>
                <td><strong>${p.matricule}</strong></td>
                <td>${p.nom_prenom}</td>
                <td>${p.secteur || '-'}</td>
                <td>${p.division || '-'}</td>
                <td>${p.fonction || '-'}</td>
                <td>${p.salaire_tarif ? parseFloat(p.salaire_tarif).toFixed(2) : '-'}</td>
                <td>
                    ${badgeActif}
                    <button class="btn btn-sm btn-warning ms-1" onclick="alert('Fonction d\'édition à venir')">
                        <i class="fas fa-edit"></i>
                    </button>
                </td>
            </tr>
        `);
    });
}

function filterPersonnel() {
    const search = $('#searchInput').val().toLowerCase();
    const divisionFilter = $('#filterDivision').val();
    const actifFilter = $('#filterActif').val();
    
    const filtered = personnelData.filter(p => {
        const matchSearch = p.matricule.toLowerCase().includes(search) ||
                          p.nom_prenom.toLowerCase().includes(search) ||
                          (p.division && p.division.toLowerCase().includes(search)) ||
                          (p.secteur && p.secteur.toLowerCase().includes(search));
        
        const matchDivision = !divisionFilter || p.division === divisionFilter;
        
        let matchActif = true;
        if (actifFilter === 'true') matchActif = p.actif === true;
        else if (actifFilter === 'false') matchActif = p.actif === false;
        
        return matchSearch && matchDivision && matchActif;
    });
    
    displayPersonnel(filtered);
}
</script>
{% endblock %}

